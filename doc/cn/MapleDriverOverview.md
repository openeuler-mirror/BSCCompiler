# maple驱动程序概述
## 简介
本文档描述了maple驱动程序的当前状态。这包括设计、使用、目标和内部实施。

## 目标
maple驱动程序旨在满足优秀编译器（如clang）的要求。换句话说，它应该是：
-灵活支持新功能
-高效，开销低
-易于使用

驱动程序开发的最终目标是完全支持gcc选项，并直接集成到CMake构建系统中。

## 设计和实现

### 设计概述

下图显示了maple驱动程序体系结构的重要组件以及它们之间的关系。红色组件表示基本的驱动程序部分（类、方法），蓝色组件是输出/输入数据结构，绿色组件是重要的帮助器类。

![](media/MapleDriverStructure.png)

### 驱动程序阶段

驱动程序功能可分为五个阶段：

**1.解析选项**

首先检查输入命令行参数字符串的格式正确性，并将其转换为键值对，然后检查键是否在`OptionParser`的`usage`多映射（以前从帮助数据结构创建）中匹配。Option类还包含Descriptor数据结构，用一些附加数据描述选项参数所需的解析细节。然后解析参数。驱动程序希望了解所有可用选项。然后，结果将写入`OptionParser`类的`options`向量中。


**2.填充MplOptions**

解析输入后，根据结果填充`MplOptions`：首先确定运行类型为自动或者自定义（取决于`--run`选项），然后初始化输入文件并检查有效性。如果运行类型为自动maple驱动程序还将自行配置代码生成管道（您将接收汇编程序文件作为最终输出），具体取决于第一个输入文件的扩展名。然后处理其他选项，包括`--option`，其值必须包含所有编译阶段的选项，使用解析通用选项时相同方法和数据结构来解析值，结果将存放到`MplOptions`类的`exeOptions`映射中。然后，maple驱动程序尝试打开输入文件，如果成功，将进入下一阶段。

**3.编译器选择**

上一阶段完成后，maple驱动程序触发`CompilerFactory`类构造函数，该构造函数创建受支持编译器的类，并将指向所有编译器的指针保存在`supportedCompilers`数据结构中。

**4.阶段特定选项构建**

`CompilerFactory`调用选定编译器的`Compile`方法，该方法构造默认和自定义的选项并写入字符串中。主要的问题是命令从一种风格转换到另一种风格，一些驱动程序组件需要自己的方法正确运行，如`MplcgCompiler`；而另一些组件只使用几个选项，它们的主要目的是确定要调用的可执行文件的路径和传递它们的输入和输出参数，如`AsCompiler`。

但是，`MaplecombCompiler`和`MplcgCompiler`需要特殊的管道，它们不调用可执行文件给它们传递命令行，而是使用`MIRModule`、`mirParser`和`DriverRunner`类与输入文件交互。`MIRModule`是一种数据结构，其功能类似于`MplOptions`，`MaplecombCompiler`和`MplcgCompiler`会在其中存储关键数据（输入文件的名称、源语言等）；`MIRParser`是为了解析maple IR; `DriverRunner`是一个协调器，它可以与以前的两个数据结构一起工作，同时还存储其负责的阶段的选项和编译中所需的其他数据。

**5.执行**

之后，可执行文件的命令行和完整路径将重定向到`SafeExe`类的`Exe`方法，在那里它通过子进程处理和执行。如果是`MaplecombCompiler`和`MplcgCompiler`，则调用`DriverRunner`的`Run`方法，并将作业发布到阶段管理器。